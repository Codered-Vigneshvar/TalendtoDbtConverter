<!-- talenttodbt.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Talend to DBT Converter</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:1200px; margin:0 auto; padding:20px }
    h1,h2 { color:#333 }
    #raw-output, #sql-output {
      background:#f5f5f5; padding:15px; border-radius:5px;
      overflow:auto; white-space:pre-wrap;
      min-height:100px; max-height:400px;
    }
    .input-container {
      margin:20px 0; padding:15px; background:#f9f9f9;
      border-radius:5px; display:flex; align-items:center; gap:10px;
    }
    button {
      padding:10px 20px; background:#4CAF50; color:#fff;
      border:none; border-radius:4px; cursor:pointer;
    }
    button:disabled { background: #aaa; cursor: not-allowed; }
    button:hover:not(:disabled) { background:#45a049 }
    ul { list-style:none; padding-left:0 }
    ul li { margin:10px 0 }
    ul li a {
      color:#0066cc; text-decoration:none; padding:5px 10px;
      border:1px solid #0066cc; border-radius:4px; display:inline-block;
    }
    ul li a:hover { background:#e6f0ff }
  </style>
</head>
<body>
  <h1>Talend to DBT Converter</h1>

  <div class="input-container">
    <label for="file-input">Select .item file:</label>
    <input id="file-input" type="file" accept=".item"/>
    <span id="file-name"></span>
    <button id="convert-btn">Convert</button>
  </div>

  <h2>Extracted MetaData</h2>
  <pre id="raw-output">(waiting...)</pre>

  <h2>Download Links</h2>
  <ul id="links"></ul>

  <div class="input-container">
    <button id="get-code-btn" disabled>Get Properly Commented SQL</button>
  </div>

  <h2>Map Talend to Dbt Model</h2>
  <pre id="sql-output">(not generated yet)</pre>

  <h2>Download SQL Model</h2>
  <ul id="sql-links"></ul>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput   = document.getElementById('file-input'),
            fileName    = document.getElementById('file-name'),
            convertBtn  = document.getElementById('convert-btn'),
            rawOutput   = document.getElementById('raw-output'),
            links       = document.getElementById('links'),
            getCodeBtn  = document.getElementById('get-code-btn'),
            sqlOutput   = document.getElementById('sql-output'),
            sqlLinks    = document.getElementById('sql-links');

      let lastData = null;

      fileInput.addEventListener('change', () => {
        fileName.textContent = fileInput.files[0]?.name || '';
      });

      convertBtn.addEventListener('click', async () => {
        if (!fileInput.files.length) {
          alert('Please select an .item file.');
          return;
        }
        rawOutput.textContent = 'Uploading and converting…';
        links.innerHTML = '';
        sqlOutput.textContent = '(not generated yet)';
        sqlLinks.innerHTML = '';
        getCodeBtn.disabled = true;
        lastData = null;

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
          const resp = await fetch('/convert', { method:'POST', body: formData });
          const ct   = resp.headers.get('content-type') || '';
          let data;
          if (ct.includes('application/json')) {
            data = await resp.json();
          } else {
            const text = await resp.text();
            rawOutput.textContent = `Server error: ${text}`;
            return;
          }

          console.log('Convert response:', data);
          if (!resp.ok) {
            rawOutput.textContent = `Error: ${data.error || 'Unknown error'}`;
            return;
          }

          lastData = data;
          rawOutput.textContent = data.raw_output || '(no output)';
          links.innerHTML = '';
          Object.entries(data.files || {}).forEach(([label, url]) => {
            const li = document.createElement('li'),
                  a  = document.createElement('a');
            a.href        = url;
            a.textContent = `Download ${label}`;
            a.target      = '_blank';
            li.appendChild(a);
            links.appendChild(li);
          });

          getCodeBtn.disabled = false;
        } catch (e) {
          rawOutput.textContent = 'Error connecting to server: ' + e.message;
        }
      });

      getCodeBtn.addEventListener('click', async () => {
        if (!lastData) return;
        getCodeBtn.disabled = true;
        sqlOutput.textContent = 'Generating commented SQL…';
        sqlLinks.innerHTML = '';

        try {
          const resp = await fetch('/generate_sql', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(lastData)
          });
          const ct   = resp.headers.get('content-type') || '';
          let data;
          if (ct.includes('application/json')) {
            data = await resp.json();
          } else {
            const text = await resp.text();
            sqlOutput.textContent = `Server error: ${text}`;
            return;
          }

          console.log('Generate SQL response:', data);
          if (!resp.ok) {
            sqlOutput.textContent = `Error: ${data.error || 'Unknown error'}`;
            return;
          }

          sqlOutput.textContent = data.sql_output || '(no output)';
          sqlLinks.innerHTML = '';
          if (data.file_url) {
            const li = document.createElement('li'),
                  a  = document.createElement('a');
            a.href        = data.file_url;
            a.textContent = 'Download commented SQL';
            a.target      = '_blank';
            li.appendChild(a);
            sqlLinks.appendChild(li);
          }
        } catch (e) {
          sqlOutput.textContent = 'Error connecting to server: ' + e.message;
        } finally {
          getCodeBtn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
